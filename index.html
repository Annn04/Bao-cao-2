<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<script>
async function readExcel(url){
  const res = await fetch(url);
  const buf = await res.arrayBuffer();
  const wb = XLSX.read(buf,{type:"array"});
  const sheet = wb.Sheets[wb.SheetNames[0]];
  const raw = XLSX.utils.sheet_to_json(sheet,{header:1});
  const headers = raw[0];
  return raw.slice(1).map(r=>{
    let o={};
    headers.forEach((h,i)=>o[h]=r[i]);
    return o;
  });
}

Promise.all([
  readExcel("data.xlsx"),   // Danh s√°ch thu√™ bao
  readExcel("donvi.xlsx")   // Danh s√°ch ƒë∆°n v·ªã
]).then(([thueBao, donVi])=>{

  // Map ƒë∆°n v·ªã theo MST
  const DONVI_MAP = {};
  donVi.forEach(d=>{
    DONVI_MAP[String(d.MST).trim()] = d;
  });

  // Gh√©p d·ªØ li·ªáu thu√™ bao + ƒë∆°n v·ªã
  const CHI_TIET = thueBao.map(tb=>{
    const mst = String(tb.MST).trim();
    const dv = DONVI_MAP[mst] || {};
    return {
      TEN_DTNT: dv.TEN_DTNT || "Ch∆∞a ƒë·ªëi chi·∫øu",
      MST: mst,
      TEN_XA: dv["T√™n x√£"] || "",
      LOAIHINH_TB: tb.LOAIHINH_TB || "",
      MA_TB: tb.MA_TB || "",
      DOANH_THU: tb.DOANH_THU || 0
    };
  });

  hienBangChiTiet(CHI_TIET);
});

function hienBangChiTiet(data){
  let h = `
    <h3>üìã B·∫¢NG ƒê·ªêI CHI·∫æU ƒê∆†N V·ªä ‚Äì THU√ä BAO</h3>
    <table border="1" cellpadding="6" cellspacing="0">
      <tr>
        <th>T√™n ƒë∆°n v·ªã</th>
        <th>MST</th>
        <th>T√™n x√£</th>
        <th>Lo·∫°i h√¨nh thu√™ bao</th>
        <th>M√£ thu√™ bao</th>
        <th>Doanh thu</th>
      </tr>
  `;

  data.forEach(r=>{
    h += `
      <tr>
        <td>${r.TEN_DTNT}</td>
        <td>${r.MST}</td>
        <td>${r.TEN_XA}</td>
        <td>${r.LOAIHINH_TB}</td>
        <td>${r.MA_TB}</td>
        <td style="text-align:right">${Number(r.DOANH_THU).toLocaleString()}</td>
      </tr>
    `;
  });

  h += "</table>";
  document.body.innerHTML = h;
}
</script>
